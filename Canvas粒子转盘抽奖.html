<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Canvas ç²’å­è½¬ç›˜æŠ½å¥–</title>
<style>
  body {
    margin: 0;
    background: radial-gradient(circle, #222, #000);
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    color: #fff;
    font-family: Arial;
  }

  .container {
    text-align: center;
  }

  canvas {
    display: block;
    margin: 0 auto;
  }

  button {
    margin: 12px 10px;
    padding: 10px 24px;
    font-size: 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: linear-gradient(135deg, #ffcc00, #ff6600);
    color: #000;
    box-shadow: 0 0 12px rgba(255,150,0,.8);
  }

  button:disabled {
    opacity: .4;
    cursor: not-allowed;
  }

  #settingsBtn { position: absolute; top: 10px; right: 0; font-size: 24px; }
  .modal, .prizeModal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.7);
    display: none;
    justify-content: center;
    align-items: center;
  }
  .modal-box, .prizeModal-box {
    background: #111;
    padding: 24px 32px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 0 30px #ffcc00;
  }
  textarea { width: 300px; height: 200px; margin-top: 10px; background: #222; color: #fff; border: 1px solid #555; border-radius: 6px; padding: 6px; }
</style>
</head>

<body>
<div class="container">
  <canvas id="canvas" width="600" height="600"></canvas>
  <div>
    <button id="startBtn">å¼€å§‹æŠ½å¥–</button>
    <button id="settingsBtn">âš™ï¸</button>
  </div>
</div>


<!-- ä¸­å¥–å¼¹æ¡† -->
<div class="modal" id="modal">
  <div class="modal-box">
    <h2>ğŸ‰ æŠ½å¥–ç»“æœ</h2>
    <p id="result"></p>
    <button onclick="closeModal()">ç¡®è®¤</button>
  </div>
</div>

<!-- å¥–å“è®¾ç½®å¼¹æ¡† -->
<div class="prizeModal" id="prizeModal">
  <div class="prizeModal-box">
    <h2>é…ç½®å¥–å“ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</h2>
    <textarea id="prizeInput"></textarea>
    <br>
    <button onclick="savePrizes()">ä¿å­˜</button>
    <button onclick="closePrizeModal()">å–æ¶ˆ</button>
  </div>
</div>

<script>
const canvas = document.getElementById('canvas')
const ctx = canvas.getContext('2d')

const startBtn = document.getElementById('startBtn')
const settingsBtn = document.getElementById('settingsBtn');
const modal = document.getElementById('modal');
const result = document.getElementById('result');
const prizeModal = document.getElementById('prizeModal');
const prizeInput = document.getElementById('prizeInput');

const cx = canvas.width / 2
const cy = canvas.height / 2
const radius = 140

// å¥–å“
let prizes = [
  "ç›–ç é¥­", "å¼€å°èœ", "é‡‘æ‹±é—¨", "è¾¾ç¾ä¹", "èƒ¡å­å¤§å¨", "æ‘¸æ‘¸å®¶", "é™ˆé¦™è´µ", 
  "æ¥¼ä¸‹å…°å·æ‹‰é¢", "å¡”ä¸æ±€", "å…«å˜King", "æ¤’é”…é”…"
]
// ç¼“å­˜å¥–å“
const saved = localStorage.getItem('prizes')
if(saved){
  prizes = JSON.parse(saved)
}

// é¢œè‰²
const colors = prizes.map(() => randomColor())  // æ¯æ¬¡é‡æ–°ç”Ÿæˆ

// è½¬ç›˜çŠ¶æ€
let angle = 0
let speed = 0
let isSpinning = false
let targetAngle = 0

// æ¯å—æ‰‡åŒºè§’åº¦
let slice = Math.PI * 2 / prizes.length

// ç²’å­
const particles = []

class Particle {
  constructor() {
    this.x = cx
    this.y = cy
    const a = Math.random() * Math.PI * 2  // éšæœºæ–¹å‘
    const v = Math.random() * 8 + 3       // æ›´å¤§åˆé€Ÿåº¦
    this.vx = Math.cos(a) * v
    this.vy = Math.sin(a) * v
    this.life = 90 + Math.random() * 30   // æ›´é•¿å¯¿å‘½
    this.r = 3 + Math.random() * 2        // ç²’å­åŠå¾„
    this.color = `hsl(${Math.random()*360},100%,60%)`
  }
  update() {
    this.x += this.vx
    this.y += this.vy
    this.vy += 0.05  // é‡åŠ›
    this.life--
  }
  draw() {
    ctx.globalAlpha = Math.max(this.life / 120, 0)
    ctx.fillStyle = this.color
    ctx.beginPath()
    ctx.arc(this.x,this.y,this.r,0,Math.PI*2)
    ctx.fill()
    ctx.globalAlpha = 1
  }
}

function randomColor() {
  const h = Math.floor(Math.random() * 360)  // è‰²ç›¸ 0~360
  const s = 70 + Math.random() * 30          // é¥±å’Œåº¦ 70~100%
  const l = 50 + Math.random() * 10          // æ˜åº¦ 50~60%
  return `hsl(${h},${s}%,${l}%)`
}

// ç»˜åˆ¶è½¬ç›˜
function drawWheel() {
  slice = Math.PI * 2 / prizes.length
  ctx.clearRect(0, 0, canvas.width, canvas.height)

  ctx.save()
  ctx.translate(cx, cy)
  ctx.rotate(angle)

  prizes.forEach((text, i) => {
    ctx.beginPath()
    ctx.fillStyle = colors[i]
    ctx.moveTo(0, 0)
    ctx.arc(0, 0, radius, i * slice, (i + 1) * slice)
    ctx.fill()

    // æ–‡æœ¬
    ctx.save()
    ctx.rotate(i * slice + slice / 2)
    ctx.fillStyle = '#fff'
    ctx.font = '16px Arial'
    ctx.textAlign = 'right'
    ctx.fillText(text, radius - 10, 5)
    ctx.restore()
  })

  ctx.restore()

  // æŒ‡é’ˆï¼ˆæœä¸‹ï¼ŒæŒ‡å‘åœ†å¿ƒï¼‰
  ctx.fillStyle = '#ffeb3b'
  ctx.beginPath()
  ctx.moveTo(cx, cy - radius + 22)   // å°–å¤´ï¼ˆé è¿‘è½¬ç›˜ï¼‰
  ctx.lineTo(cx - 12, cy - radius - 18) // å·¦ä¸Š
  ctx.lineTo(cx + 12, cy - radius - 18) // å³ä¸Š
  ctx.closePath()
  ctx.fill()
}

// åŠ¨ç”»å¾ªç¯
function animate() {
  drawWheel()

  // ç²’å­
  particles.forEach(p => {
    p.update()
    p.draw()
  })
  for (let i = particles.length - 1; i >= 0; i--) {
    if (particles[i].life <= 0) particles.splice(i, 1)
  }

  if (isSpinning) {
    angle += speed
    speed *= 0.985

    // æ¥è¿‘ç›®æ ‡ï¼Œåœæ­¢
    if (speed < 0.002) {
      isSpinning = false
      explode()
      
      setTimeout(showResult, 300)
    }
  }

  requestAnimationFrame(animate)
}

// ç²’å­çˆ†å‘
function explode() {
  const count = 300 + Math.floor(Math.random() * 200)  // 300~500é¢—
  for (let i=0; i<count; i++) particles.push(new Particle())
}

// æ˜¾ç¤ºç»“æœ
function showResult() {
  const index = getPrizeIndex()
  console.log(`è·å¥–ç´¢å¼•: ${index}`)
  // alert(`ğŸ‰ GOç‚«é¥­ï¼š${prizes[index]}`)
  result.innerText = `GOç‚«é¥­ï¼š${prizes[index]}`;
  modal.style.display='flex';
  startBtn.disabled=false;
}

// å½“å‰æŒ‡é’ˆæ–¹å‘å¯¹åº”çš„å¥–é¡¹ç´¢å¼•
function getPrizeIndex() {
  const slice = Math.PI * 2 / prizes.length

  // è½¬ç›˜å½“å‰è§’åº¦
  let normalizedAngle = angle % (Math.PI * 2)
  if (normalizedAngle < 0) normalizedAngle += Math.PI * 2

  // ç®­å¤´åœ¨æ­£ä¸Šæ–¹ï¼Œåç§» -Ï€/2
  let arrowAngle = (normalizedAngle + Math.PI/2) % (Math.PI*2)

  // é¡ºæ—¶é’ˆè®¡ç®—å½“å‰æ‰‡åŒº
  let index = Math.floor(arrowAngle / slice)

  // å¥–é¡¹æ•°ç»„é¡ºåºå¯èƒ½ä¸ Canvas æ‰‡åŒºé¡ºåºåå‘
  // ä¿®æ­£åç§» 1 ä¸ª
  index = (prizes.length - index - 1 + prizes.length) % prizes.length

  return index
}

// å¼€å§‹æŠ½å¥–
startBtn.onclick = () => {
  if (isSpinning) return
  startBtn.disabled = true

  // ğŸ‘‰ è¿™é‡Œå¯æ›¿æ¢ä¸ºåç«¯è¿”å›çš„ index
  const finalIndex = Math.floor(Math.random() * prizes.length)

  targetAngle =
    Math.PI * 2 * 6 +
    (prizes.length - finalIndex) * slice -
    slice / 2

  speed = 0.35
  isSpinning = true
}

// è®¾ç½®å¥–å“
settingsBtn.onclick = ()=>{
  prizeInput.value = prizes.join('\n');
  prizeModal.style.display='flex';
}

function savePrizes(){
  const lines = prizeInput.value.split('\n').map(l=>l.trim()).filter(l=>l);
  if(lines.length>0){
    prizes = lines;
    localStorage.setItem('prizes', JSON.stringify(prizes))
  }
  prizeModal.style.display='none';
  drawWheel();
}

function closeModal(){ modal.style.display='none'; }
function closePrizeModal(){ prizeModal.style.display='none'; }

// å¯åŠ¨
animate()
</script>
</body>
</html>
